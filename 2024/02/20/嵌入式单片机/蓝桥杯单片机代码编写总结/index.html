<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>蓝桥杯单片机代码编写总结 | 左窗的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="一、初始化 Y4控制LED，Y5控制蜂鸣器和继电器，Y6控制数码管位选，Y7控制数码管段选。通过以下代码实现对74HC138译码器的控制，进而选通相应模块： 1234void init74hc138(unsigned char n)&#123;    P2&#x3D;(P2&amp;0x1f)|(n&lt;&lt;5);    P2&amp;&#x3D;0x1f;&#125; 而系统初始化函数 init() 负责关闭">
<meta property="og:type" content="article">
<meta property="og:title" content="蓝桥杯单片机代码编写总结">
<meta property="og:url" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="左窗的博客">
<meta property="og:description" content="一、初始化 Y4控制LED，Y5控制蜂鸣器和继电器，Y6控制数码管位选，Y7控制数码管段选。通过以下代码实现对74HC138译码器的控制，进而选通相应模块： 1234void init74hc138(unsigned char n)&#123;    P2&#x3D;(P2&amp;0x1f)|(n&lt;&lt;5);    P2&amp;&#x3D;0x1f;&#125; 而系统初始化函数 init() 负责关闭">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_01.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_02.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_03.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_04.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_05.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_06.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_07.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_08.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_09.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_10.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_11.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_12.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_13.png">
<meta property="og:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_14.png">
<meta property="article:published_time" content="2024-02-20T07:45:00.000Z">
<meta property="article:modified_time" content="2025-11-05T16:41:03.106Z">
<meta property="article:author" content="左窗（默蝶）">
<meta property="article:tag" content="技术,诗歌,生活">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_01.png">
  
    <link rel="alternate" href="/atom.xml" title="左窗的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <style>
  .busuanzi-count { 
    opacity: 0;
    transition: opacity 0.5s;
  }
  .loaded .busuanzi-count { 
    opacity: 1; 
  }
  </style>
  <script>
  window.addEventListener('load', () => {
    document.body.classList.add('loaded');
  });
  </script>
<meta name="generator" content="Hexo 8.1.1"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">左窗的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">记录技术踩坑与生活碎片</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
      </nav>
      <nav id="sub-nav">
        
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/759Li"><span class="fa fa-github"></span></a>
          
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://759Li.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-嵌入式单片机/蓝桥杯单片机代码编写总结" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/" class="article-date">
  <time class="dt-published" datetime="2024-02-20T07:45:00.000Z" itemprop="datePublished">2024年02月20日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/">嵌入式单片机</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      蓝桥杯单片机代码编写总结
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、初始化"><a href="#一、初始化" class="headerlink" title="一、初始化"></a>一、初始化</h2><p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_01.png"></p>
<p>Y4控制LED，Y5控制蜂鸣器和继电器，Y6控制数码管位选，Y7控制数码管段选。通过以下代码实现对74HC138译码器的控制，进而选通相应模块：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">init74hc138</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> n)</span>&#123;</span><br><span class="line">    P2=(P2&amp;<span class="number">0x1f</span>)|(n&lt;&lt;<span class="number">5</span>);</span><br><span class="line">    P2&amp;=<span class="number">0x1f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而系统初始化函数 <code>init()</code> 负责关闭蜂鸣器、继电器并熄灭LED：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    P0=<span class="number">0x00</span>;</span><br><span class="line">    init74hc138(<span class="number">5</span>);</span><br><span class="line">    P0=<span class="number">0xff</span>;</span><br><span class="line">    init74hc138(<span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化的精准设置，为后续各个功能模块的稳定运行奠定了坚实基础。</p>
<h2 id="二、按键（补充双按键与双击操作）"><a href="#二、按键（补充双按键与双击操作）" class="headerlink" title="二、按键（补充双按键与双击操作）"></a>二、按键（补充双按键与双击操作）</h2><p>在竞赛中，双按键联动与双击确认等操作可实现模式切换、功能重置、参数微调等高级功能，这些功能的实现依赖精确的状态检测与逻辑判断。</p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_02.png"></p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_03.png"></p>
<h3 id="（一）基础按键状态定义（通用）"><a href="#（一）基础按键状态定义（通用）" class="headerlink" title="（一）基础按键状态定义（通用）"></a>（一）基础按键状态定义（通用）</h3><p>为实现复杂按键操作，首先需定义一系列全局变量记录按键核心状态，为后续操作提供基础。以下以独立按键为例说明，矩阵按键可依相同原理类比扩展。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按键核心状态变量（独立按键示例，矩阵按键可类比扩展）</span></span><br><span class="line">sbit S4 = P3^<span class="number">3</span>;  <span class="comment">// 按键1</span></span><br><span class="line">sbit S5 = P3^<span class="number">2</span>;  <span class="comment">// 按键2（用于双按键操作）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> keyVal = <span class="number">0</span>;    <span class="comment">// 当前按键值（0：无按键，4：S4，5：S5，6：S4+S5双按）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> keyOld = <span class="number">0</span>;    <span class="comment">// 上一次按键值</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> keyDown = <span class="number">0</span>;   <span class="comment">// 按键按下标志（仅按下瞬间置1）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> keyUp = <span class="number">0</span>;     <span class="comment">// 按键抬起标志（仅抬起瞬间置1）</span></span><br><span class="line"><span class="comment">// 双击检测专用变量</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> doubleClickTimer = <span class="number">0</span>;  <span class="comment">// 双击计时（单位：ms，需定时器支持）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> doubleClickFlag = <span class="number">0</span>;  <span class="comment">// 双击成功标志（1：双击触发）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> clickCount = <span class="number">0</span>;       <span class="comment">// 按键按下次数（1次：单按，2次：双击）</span></span><br></pre></td></tr></table></figure>

<h3 id="（二）双按键操作（独立按键）"><a href="#（二）双按键操作（独立按键）" class="headerlink" title="（二）双按键操作（独立按键）"></a>（二）双按键操作（独立按键）</h3><p>双按键操作的关键在于准确检测到两个按键同时按下的瞬间，并通过有效消抖逻辑排除按键先后按下的误判情况。此操作在实际应用中常用于模式切换、功能重置等场景，为系统提供更丰富交互方式。</p>
<h4 id="1-双按键扫描（含消抖）"><a href="#1-双按键扫描（含消抖）" class="headerlink" title="1. 双按键扫描（含消抖）"></a>1. 双按键扫描（含消抖）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消抖函数（10ms延时，避免按键抖动误触发）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Key_Debounce</span><span class="params">(sbit key)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="number">0</span>) &#123;  <span class="comment">// 检测到按键按下</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> delay = <span class="number">1000</span>;  <span class="comment">// 约10ms延时（12MHz晶振）</span></span><br><span class="line">        <span class="keyword">while</span> (delay--);</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="number">0</span>) flag = <span class="number">1</span>;  <span class="comment">// 消抖后仍按下，确认有效</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 双按键扫描函数：返回当前按键值（0：无，4：S4，5：S5，6：S4+S5）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">ScanKey_Double</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> s4Stat = Key_Debounce(S4);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> s5Stat = Key_Debounce(S5);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (s4Stat &amp;&amp; s5Stat) <span class="keyword">return</span> <span class="number">6</span>;    <span class="comment">// 双键同时按下</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s4Stat) <span class="keyword">return</span> <span class="number">4</span>;         <span class="comment">// 仅S4按下</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s5Stat) <span class="keyword">return</span> <span class="number">5</span>;         <span class="comment">// 仅S5按下</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;                     <span class="comment">// 无按键</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-双按键状态处理"><a href="#2-双按键状态处理" class="headerlink" title="2. 双按键状态处理"></a>2. 双按键状态处理</h4><p>将双按键扫描和状态处理集成到原有的 <code>Key_Loop</code> 函数中，新增对双按键状态的判断及相应功能执行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Key_Loop</span><span class="params">()</span> &#123;</span><br><span class="line">    keyVal = ScanKey_Double();  <span class="comment">// 调用双按键扫描函数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算按键按下/抬起标志</span></span><br><span class="line">    keyDown = keyVal &amp; (keyOld ^ keyVal);  <span class="comment">// 新按下瞬间置1</span></span><br><span class="line">    keyUp = ~keyVal &amp; (keyOld ^ keyVal);   <span class="comment">// 新抬起瞬间置1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 双按键逻辑示例（可根据需求修改）</span></span><br><span class="line">    <span class="keyword">if</span> (keyDown == <span class="number">6</span>) &#123;  <span class="comment">// 双键同时按下瞬间</span></span><br><span class="line">        <span class="comment">// 执行双键功能（如：系统重置、模式切换）</span></span><br><span class="line">        init();  <span class="comment">// 调用初始化函数，关闭蜂鸣器/LED等</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    keyOld = keyVal;  <span class="comment">// 更新上一次按键值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（三）按键双击检测（独立按键）"><a href="#（三）按键双击检测（独立按键）" class="headerlink" title="（三）按键双击检测（独立按键）"></a>（三）按键双击检测（独立按键）</h3><p>双击检测的核心在于通过精确计时判断两次按键按下之间的时间间隔，通常设定在300 - 500ms之间。为实现非阻塞计时，需借助1ms定时器完成。此操作常用于确认操作、参数微调等场景，进一步丰富人机交互方式。</p>
<h4 id="1-定时器初始化（1ms中断，用于计时）"><a href="#1-定时器初始化（1ms中断，用于计时）" class="headerlink" title="1. 定时器初始化（1ms中断，用于计时）"></a>1. 定时器初始化（1ms中断，用于计时）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定时器0初始化（1ms@12MHz晶振，用于双击计时）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Timer0_Init</span><span class="params">()</span> &#123;</span><br><span class="line">    TMOD &amp;= <span class="number">0xF0</span>;  <span class="comment">// 清空定时器0模式</span></span><br><span class="line">    TMOD |= <span class="number">0x01</span>;  <span class="comment">// 定时器0工作模式1（16位自动重装）</span></span><br><span class="line">    TL0 = <span class="number">0x66</span>;    <span class="comment">// 初值计算：1ms = (65536 - 1000*12) = 0xFC66</span></span><br><span class="line">    TH0 = <span class="number">0xFC</span>;</span><br><span class="line">    ET0 = <span class="number">1</span>;       <span class="comment">// 使能定时器0中断</span></span><br><span class="line">    TR0 = <span class="number">1</span>;       <span class="comment">// 启动定时器0</span></span><br><span class="line">    EA = <span class="number">1</span>;        <span class="comment">// 使能总中断</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定时器0中断服务函数（更新双击计时）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Timer0_Isr</span><span class="params">()</span> interrupt 1 &#123;</span><br><span class="line">    TL0 = <span class="number">0x66</span>;    <span class="comment">// 重装初值</span></span><br><span class="line">    TH0 = <span class="number">0xFC</span>;</span><br><span class="line">    <span class="keyword">if</span> (doubleClickTimer &lt; <span class="number">500</span>) &#123;  <span class="comment">// 计时上限500ms（双击间隔阈值）</span></span><br><span class="line">        doubleClickTimer++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-双击检测逻辑"><a href="#2-双击检测逻辑" class="headerlink" title="2. 双击检测逻辑"></a>2. 双击检测逻辑</h4><p>在 <code>Key_Loop</code> 函数中扩展对双击状态的处理逻辑，以实现准确的双击检测及相应功能触发。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Key_Loop</span><span class="params">()</span> &#123;</span><br><span class="line">    keyVal = ScanKey_Double();  <span class="comment">// 基础扫描（此处以S4为例实现双击，可指定按键）</span></span><br><span class="line">    keyDown = keyVal &amp; (keyOld ^ keyVal);</span><br><span class="line">    keyUp = ~keyVal &amp; (keyOld ^ keyVal);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 双击检测核心逻辑（以S4按键为例）</span></span><br><span class="line">    <span class="keyword">if</span> (keyDown == <span class="number">4</span>) &#123;  <span class="comment">// 检测到S4按下</span></span><br><span class="line">        <span class="keyword">if</span> (clickCount == <span class="number">0</span>) &#123;  <span class="comment">// 第一次按下</span></span><br><span class="line">            clickCount = <span class="number">1</span>;</span><br><span class="line">            doubleClickTimer = <span class="number">0</span>;  <span class="comment">// 重置计时</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clickCount == <span class="number">1</span> &amp;&amp; doubleClickTimer &lt;= <span class="number">500</span>) &#123;  <span class="comment">// 500ms内第二次按下</span></span><br><span class="line">            clickCount = <span class="number">0</span>;</span><br><span class="line">            doubleClickFlag = <span class="number">1</span>;  <span class="comment">// 置位双击成功标志</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 双击计时超时：500ms内未第二次按下，重置为单按状态</span></span><br><span class="line">    <span class="keyword">if</span> (clickCount == <span class="number">1</span> &amp;&amp; doubleClickTimer &gt; <span class="number">500</span>) &#123;</span><br><span class="line">        clickCount = <span class="number">0</span>;</span><br><span class="line">        doubleClickFlag = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 双击功能执行（根据标志触发）</span></span><br><span class="line">    <span class="keyword">if</span> (doubleClickFlag == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 执行双击功能（如：参数确认、数值保存）</span></span><br><span class="line">        doubleClickFlag = <span class="number">0</span>;  <span class="comment">// 重置标志，避免重复触发</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    keyOld = keyVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（四）矩阵按键的复杂操作扩展"><a href="#（四）矩阵按键的复杂操作扩展" class="headerlink" title="（四）矩阵按键的复杂操作扩展"></a>（四）矩阵按键的复杂操作扩展</h3><p>矩阵按键的双按键、双击逻辑与独立按键实现原理基本一致，仅扫描函数需依矩阵按键硬件连接修改。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 矩阵按键双按键扫描（示例：检测按键7与按键6同时按下）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">ScanMatrix_Double</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> col, row;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> keyStat[<span class="number">4</span>][<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;  <span class="comment">// 矩阵按键状态表</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 扫描所有按键状态（消抖后存储）</span></span><br><span class="line">    <span class="keyword">for</span> (col = <span class="number">0</span>; col &lt; <span class="number">4</span>; col++) &#123;</span><br><span class="line">        <span class="comment">// 列选通（根据硬件连接调整IO口）</span></span><br><span class="line">        P4 = (P4 &amp; <span class="number">0x0F</span>) | (<span class="number">0x10</span> &lt;&lt; col);  </span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> delay = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">while</span> (delay--);  <span class="comment">// 消抖</span></span><br><span class="line">        <span class="comment">// 读取行状态</span></span><br><span class="line">        <span class="keyword">for</span> (row = <span class="number">0</span>; row &lt; <span class="number">4</span>; row++) &#123;</span><br><span class="line">            keyStat[row][col] = !(P3 &amp; (<span class="number">0x01</span> &lt;&lt; row));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 检测双按键（示例：按键7（row0,col0）与按键6（row1,col0）同时按下）</span></span><br><span class="line">    <span class="keyword">if</span> (keyStat[<span class="number">0</span>][<span class="number">0</span>] &amp;&amp; keyStat[<span class="number">1</span>][<span class="number">0</span>]) <span class="keyword">return</span> <span class="number">0x76</span>;  <span class="comment">// 自定义双按键值</span></span><br><span class="line">    <span class="comment">// 3. 检测单按键（返回对应键值，略）</span></span><br><span class="line">    <span class="comment">// ...（原有单按键扫描逻辑）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、数码管"><a href="#三、数码管" class="headerlink" title="三、数码管"></a>三、数码管</h2><p>数码管作为信息展示窗口，其显示效果直接影响竞赛成果。Y6控制数码管位选，Y7控制数码管段选。</p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_04.png"></p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_05.png"></p>
<p>首先定义共阳数码管段码表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">code <span class="type">unsigned</span> <span class="type">char</span> Seg_Table[] = &#123;</span><br><span class="line">    <span class="number">0xc0</span>, <span class="comment">//0</span></span><br><span class="line">    <span class="number">0xf9</span>, <span class="comment">//1</span></span><br><span class="line">    <span class="number">0xa4</span>, <span class="comment">//2</span></span><br><span class="line">    <span class="number">0xb0</span>, <span class="comment">//3</span></span><br><span class="line">    <span class="number">0x99</span>, <span class="comment">//4</span></span><br><span class="line">    <span class="number">0x92</span>, <span class="comment">//5</span></span><br><span class="line">    <span class="number">0x82</span>, <span class="comment">//6</span></span><br><span class="line">    <span class="number">0xf8</span>, <span class="comment">//7</span></span><br><span class="line">    <span class="number">0x80</span>, <span class="comment">//8</span></span><br><span class="line">    <span class="number">0x90</span>, <span class="comment">//9</span></span><br><span class="line">    <span class="number">0x88</span>, <span class="comment">//A 10</span></span><br><span class="line">    <span class="number">0x83</span>, <span class="comment">//b 11</span></span><br><span class="line">    <span class="number">0xc6</span>, <span class="comment">//C 12 </span></span><br><span class="line">    <span class="number">0xa1</span>, <span class="comment">//d 13</span></span><br><span class="line">    <span class="number">0x86</span>, <span class="comment">//E 14</span></span><br><span class="line">    <span class="number">0x8e</span>, <span class="comment">//F 15</span></span><br><span class="line">        <span class="number">0xff</span>  <span class="comment">//熄灭 16</span></span><br><span class="line">&#125;;<span class="comment">//共阳数码管段码表</span></span><br><span class="line"><span class="comment">//考试会给，即使不给也能推，使用电脑计算器的程序员模式很方便</span></span><br></pre></td></tr></table></figure>
<p>并通过以下代码实现数码管的显示与刷新：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> SegBuff[<span class="number">8</span>]=&#123;<span class="number">16</span>,<span class="number">16</span>,<span class="number">16</span>,<span class="number">16</span>,<span class="number">16</span>,<span class="number">16</span>,<span class="number">16</span>,<span class="number">16</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> point[<span class="number">8</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Seg</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr,number,dot)</span></span><br><span class="line">&#123;</span><br><span class="line">    P0=<span class="number">0xff</span>;</span><br><span class="line">    init74hc138(<span class="number">7</span>);</span><br><span class="line">    P0=<span class="number">0x01</span>&lt;&lt;addr;</span><br><span class="line">    init74hc138(<span class="number">6</span>);</span><br><span class="line">    P0=Seg_Table[number];</span><br><span class="line">    <span class="keyword">if</span>(dot)</span><br><span class="line">        P0&amp;=<span class="number">0x7f</span>;</span><br><span class="line">    init74hc138(<span class="number">7</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Seg_Loop</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> i=<span class="number">0</span>;</span><br><span class="line">    Seg(i,SegBuff[i],point[i]);</span><br><span class="line">    i++;</span><br><span class="line">    <span class="keyword">if</span>(i==<span class="number">8</span>)i=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、单总线协议（onewire-c的使用）"><a href="#四、单总线协议（onewire-c的使用）" class="headerlink" title="四、单总线协议（onewire.c的使用）"></a>四、单总线协议（onewire.c的使用）</h2><p>DS18B20温度传感器采用单总线协议获取温度数据。官方提供基础操作函数，在此基础上添加获取温度的功能代码。</p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_06.png"></p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_07.png"></p>
<h3 id="官方代码"><a href="#官方代码" class="headerlink" title="官方代码"></a>官方代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Delay_OneWire</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> t)</span>  </span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">while</span>(t--)&#123;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">12</span>;i++);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Write_DS18B20</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> dat)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">  &#123;</span><br><span class="line">    DQ = <span class="number">0</span>;					</span><br><span class="line">    DQ = dat&amp;<span class="number">0x01</span>;      </span><br><span class="line">    Delay_OneWire(<span class="number">5</span>);	</span><br><span class="line">    DQ = <span class="number">1</span>;				</span><br><span class="line">    dat &gt;&gt;= <span class="number">1</span>;				</span><br><span class="line">  &#125;</span><br><span class="line">  Delay_OneWire(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Read_DS18B20</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> dat;		</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">  &#123;</span><br><span class="line">    DQ = <span class="number">0</span>;</span><br><span class="line">    dat &gt;&gt;= <span class="number">1</span>;					</span><br><span class="line">    DQ = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(DQ)</span><br><span class="line">    &#123;</span><br><span class="line">      dat |= <span class="number">0x80</span>;		</span><br><span class="line">    &#125;	    </span><br><span class="line">    Delay_OneWire(<span class="number">5</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> dat;</span><br><span class="line">&#125;</span><br><span class="line">bit <span class="title function_">init_ds18b20</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    bit initflag = <span class="number">0</span>;	</span><br><span class="line">    DQ = <span class="number">1</span>;						</span><br><span class="line">    Delay_OneWire(<span class="number">12</span>);	</span><br><span class="line">    DQ = <span class="number">0</span>;					</span><br><span class="line">    Delay_OneWire(<span class="number">80</span>);	</span><br><span class="line">    DQ = <span class="number">1</span>;						</span><br><span class="line">    Delay_OneWire(<span class="number">10</span>);	</span><br><span class="line">    initflag = DQ;       </span><br><span class="line">    Delay_OneWire(<span class="number">5</span>);		</span><br><span class="line">    <span class="keyword">return</span> initflag;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义添加部分"><a href="#自定义添加部分" class="headerlink" title="自定义添加部分"></a>自定义添加部分</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sbit DQ=P1^<span class="number">4</span>;</span><br><span class="line"><span class="comment">//记得加上引脚定义</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">getT</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> temp;</span><br><span class="line">  <span class="type">float</span> temperature;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> teH,teL;</span><br><span class="line">  init_ds18b20();</span><br><span class="line">  Write_DS18B20(<span class="number">0xcc</span>);<span class="comment">//跳过ROM操作</span></span><br><span class="line">  Write_DS18B20(<span class="number">0x44</span>);<span class="comment">//启动一次温度转换</span></span><br><span class="line"> </span><br><span class="line">  init_ds18b20();</span><br><span class="line">  Write_DS18B20(<span class="number">0xcc</span>);<span class="comment">//跳过ROM操作</span></span><br><span class="line">  Write_DS18B20(<span class="number">0xbe</span>);<span class="comment">//发送读指令</span></span><br><span class="line"> </span><br><span class="line">  teL=Read_DS18B20();<span class="comment">//读取温度值的低字节</span></span><br><span class="line">  teH=Read_DS18B20();<span class="comment">//读取温度值的高字节</span></span><br><span class="line">  temp=teH&lt;&lt;<span class="number">8</span>|teL;<span class="comment">//温度值合并为16位数</span></span><br><span class="line">  <span class="comment">//低四位为小数部分，故需要右移四位，即乘以1/16=0.0625</span></span><br><span class="line">  temperature=temp*<span class="number">0.0625</span>;</span><br><span class="line">  <span class="keyword">return</span> temperature;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>值得注意，上电时温度数值可能为85°C，可能影响测评结果，可在 <code>main()</code> 函数进入 <code>while(1)</code> 循环之前添加语句 <code>while(getT()==85);</code> 以避免该问题。</p>
<h2 id="五、SPI协议（ds1302-c的使用）"><a href="#五、SPI协议（ds1302-c的使用）" class="headerlink" title="五、SPI协议（ds1302.c的使用）"></a>五、SPI协议（ds1302.c的使用）</h2><p>DS1302用于获取日历时钟数据（BCD编码），采用SPI协议。官方代码部分需适当修改，并添加自定义读写函数。</p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_08.png"></p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_09.png"></p>
<h3 id="官方代码修改部分"><a href="#官方代码修改部分" class="headerlink" title="官方代码修改部分"></a>官方代码修改部分</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Write_Ds1302</span><span class="params">(<span class="type">unsigned</span>  <span class="type">char</span> temp)</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)     	</span><br><span class="line">  &#123; </span><br><span class="line">    SCK = <span class="number">0</span>;</span><br><span class="line">    SDA = temp&amp;<span class="number">0x01</span>;<span class="comment">//写入最低位</span></span><br><span class="line">    temp&gt;&gt;=<span class="number">1</span>; </span><br><span class="line">    SCK=<span class="number">1</span>;<span class="comment">//上升沿发送数据</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;   </span><br><span class="line"><span class="type">void</span> <span class="title function_">Write_Ds1302_Byte</span><span class="params">( <span class="type">unsigned</span> <span class="type">char</span> address,<span class="type">unsigned</span> <span class="type">char</span> dat )</span>     </span><br><span class="line">&#123;</span><br><span class="line">   RST=<span class="number">0</span>;	_nop_();</span><br><span class="line">   SCK=<span class="number">0</span>;	_nop_();</span><br><span class="line">   RST=<span class="number">1</span>; 	_nop_();  </span><br><span class="line">   Write_Ds1302(address);	</span><br><span class="line">   Write_Ds1302(dat/<span class="number">10</span>&lt;&lt;<span class="number">4</span>|dat%<span class="number">10</span>);	</span><br><span class="line"><span class="comment">//原代码为Write_Ds1302(dat);需要自己修改</span></span><br><span class="line">   RST=<span class="number">0</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">Read_Ds1302_Byte</span> <span class="params">( <span class="type">unsigned</span> <span class="type">char</span> address )</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">unsigned</span> <span class="type">char</span> i,temp=<span class="number">0x00</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  unsigned char	dat1,dat2; </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">   RST=<span class="number">0</span>;	_nop_();</span><br><span class="line">   SCK=<span class="number">0</span>;	_nop_();</span><br><span class="line">   RST=<span class="number">1</span>;	_nop_();</span><br><span class="line">   Write_Ds1302(address);</span><br><span class="line">   <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++) 	</span><br><span class="line">   &#123;		</span><br><span class="line">    SCK=<span class="number">0</span>;</span><br><span class="line">    temp&gt;&gt;=<span class="number">1</span>;	</span><br><span class="line">     <span class="keyword">if</span>(SDA)</span><br><span class="line">     temp|=<span class="number">0x80</span>;	</span><br><span class="line">     SCK=<span class="number">1</span>;</span><br><span class="line">  &#125; </span><br><span class="line">   RST=<span class="number">0</span>;	_nop_();</span><br><span class="line">   SCK=<span class="number">0</span>;	_nop_();</span><br><span class="line">  SCK=<span class="number">1</span>;	_nop_();</span><br><span class="line">  SDA=<span class="number">0</span>;	_nop_();</span><br><span class="line">  SDA=<span class="number">1</span>;	_nop_();</span><br><span class="line"><span class="comment">//下面这段以及上面的变量定义需要自己写</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    dat1=temp/16;</span></span><br><span class="line"><span class="comment">  dat2=temp%16;</span></span><br><span class="line"><span class="comment">  temp=dat1*10+dat2;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  <span class="keyword">return</span> (temp);			</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义添加部分-1"><a href="#自定义添加部分-1" class="headerlink" title="自定义添加部分"></a>自定义添加部分</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> time[]=&#123;<span class="number">50</span>,<span class="number">59</span>,<span class="number">23</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="comment">//假设初始值为：0年-星期一-0月0日23时59分50秒</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">w_ds1302</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i,addr=<span class="number">0x80</span>;</span><br><span class="line">  Write_Ds1302_Byte(<span class="number">0x8e</span>,<span class="number">0x00</span>);<span class="comment">//关掉写保护</span></span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">    Write_Ds1302_Byte(addr,time[i]);</span><br><span class="line">    addr=addr+<span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Write_Ds1302_Byte(<span class="number">0x8e</span>,<span class="number">0x80</span>);<span class="comment">//开启写保护</span></span><br><span class="line">&#125;<span class="comment">//写入数据，用于设置初始时间</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">r_ds1302</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i,addr=<span class="number">0x81</span>;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">    time[i]=Read_Ds1302_Byte(addr);</span><br><span class="line">    addr=addr+<span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;获取日历时钟数据</span><br></pre></td></tr></table></figure>

<h2 id="六、IIC协议（iic-c的使用）"><a href="#六、IIC协议（iic-c的使用）" class="headerlink" title="六、IIC协议（iic.c的使用）"></a>六、IIC协议（iic.c的使用）</h2><p>IIC协议广泛应用于数模&#x2F;模数转换以及EEPROM的读写。官方提供基础IIC操作函数，根据不同设备需求添加具体代码。</p>
<h3 id="官方代码-1"><a href="#官方代码-1" class="headerlink" title="官方代码"></a>官方代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DELAY_TIME  10</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">I2C_Delay</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">do</span>&#123;</span><br><span class="line">    _nop_();_nop_();_nop_();_nop_();_nop_();</span><br><span class="line">        _nop_();_nop_();_nop_();_nop_();_nop_();</span><br><span class="line">        _nop_();_nop_();_nop_();_nop_();_nop_();    </span><br><span class="line">    &#125;<span class="keyword">while</span>(n--);        </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//总线启动</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CStart</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  sda = <span class="number">1</span>;</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);<span class="comment">//t&gt;4.7us</span></span><br><span class="line">  sda = <span class="number">0</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  scl = <span class="number">0</span>;    </span><br><span class="line">&#125;<span class="comment">//SCL为高电平时，SDA由高电平向低电平变化</span></span><br><span class="line"><span class="comment">//总线停止</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CStop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  sda = <span class="number">0</span>;</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  sda = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">&#125;<span class="comment">//SCL为高电平时，SDA由低电平向高电平变化</span></span><br><span class="line"><span class="comment">//通过 I2C 总线发送一个字节（8 位）的数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CSendByte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> byt)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">8</span>; i++)&#123;</span><br><span class="line">    scl = <span class="number">0</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">    <span class="keyword">if</span>(byt &amp; <span class="number">0x80</span>)&#123;</span><br><span class="line">      sda = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      sda = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">    scl = <span class="number">1</span>;</span><br><span class="line">    byt &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">  &#125;</span><br><span class="line">  scl = <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//通过 I2C 总线接收一个字节（8 位）的数据</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">I2CReceiveByte</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> da;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> i;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;   </span><br><span class="line">    scl = <span class="number">1</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">    da &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(sda) </span><br><span class="line">      da |= <span class="number">0x01</span>;</span><br><span class="line">    scl = <span class="number">0</span>;</span><br><span class="line">    I2C_Delay(DELAY_TIME);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> da;    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//等待来自从设备的应答信号</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">I2CWaitAck</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> ackbit;</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  ackbit = sda; </span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  <span class="keyword">return</span> ackbit;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//发送应答信号</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2CSendAck</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> ackbit)</span></span><br><span class="line">&#123;</span><br><span class="line">  scl = <span class="number">0</span>;</span><br><span class="line">  sda = ackbit; </span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  scl = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">  scl = <span class="number">0</span>; </span><br><span class="line">  sda = <span class="number">1</span>;</span><br><span class="line">  I2C_Delay(DELAY_TIME);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义添加部分-2"><a href="#自定义添加部分-2" class="headerlink" title="自定义添加部分"></a>自定义添加部分</h3><p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_10.png"></p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_11.png"></p>
<h4 id="PCB8591：DA-AD转换"><a href="#PCB8591：DA-AD转换" class="headerlink" title="PCB8591：DA&#x2F;AD转换"></a>PCB8591：DA&#x2F;AD转换</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">sbit sda=P2^<span class="number">1</span>;</span><br><span class="line">sbit scl=P2^<span class="number">0</span>;</span><br><span class="line"><span class="comment">//从设备读取模拟转换后的数据。</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">adc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> date;</span><br><span class="line"><span class="comment">//  EA=0;</span></span><br><span class="line">  I2CStart();            <span class="comment">//S</span></span><br><span class="line">  I2CSendByte(<span class="number">0x90</span>);     <span class="comment">//写入时最低为是0</span></span><br><span class="line">  I2CWaitAck();         </span><br><span class="line">    I2CSendByte(addr);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CStart();            <span class="comment">//S</span></span><br><span class="line">  I2CSendByte(<span class="number">0x91</span>);     <span class="comment">//ADDRESS+1；PCB8591的设备地址为1001=9</span></span><br><span class="line">  I2CWaitAck();          <span class="comment">//A；主机等待PCB8591的应答信号</span></span><br><span class="line">  date=I2CReceiveByte(); <span class="comment">//DATA BYTE</span></span><br><span class="line">  I2CSendAck(<span class="number">1</span>);		   <span class="comment">//A；主机发送应答信号，由PCB8591接收</span></span><br><span class="line">  I2CStop();             <span class="comment">//P</span></span><br><span class="line"><span class="comment">//  EA=1;</span></span><br><span class="line">  <span class="keyword">return</span> date;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//向 DAC 设备写入数据以输出模拟信号。</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">DAC</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> DAC_date)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//  EA=0;</span></span><br><span class="line">  I2CStart();                <span class="comment">//S</span></span><br><span class="line">  I2CSendByte(<span class="number">0x90</span>);         <span class="comment">//ADDRESS+0；发送设备地址及读写状态，0为写</span></span><br><span class="line">  I2CWaitAck();              <span class="comment">//A；主机等待来自PCB8591的应答信号</span></span><br><span class="line">  I2CSendByte(<span class="number">0x40</span>);         <span class="comment">//CONTROL BYTE；写入控制字，</span></span><br><span class="line">    I2CWaitAck();              <span class="comment">//A；主机等待来自PCB8591的应答信号</span></span><br><span class="line">  I2CSendByte(DAC_date);     <span class="comment">//DATA BYTE；写入数据</span></span><br><span class="line">  I2CWaitAck();              <span class="comment">//A；主机等待来自PCB8591的应答信号</span></span><br><span class="line">                     <span class="comment">//根据协议，可以多次写入数据</span></span><br><span class="line">  I2CStop();                 <span class="comment">//P</span></span><br><span class="line"><span class="comment">//  EA=1;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AT24C02：EEPROM读写"><a href="#AT24C02：EEPROM读写" class="headerlink" title="AT24C02：EEPROM读写"></a>AT24C02：EEPROM读写</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//向 EEPROM 写入数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">w_eeprom</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr,<span class="type">unsigned</span> <span class="type">char</span> date)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//  EA=0;</span></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0xA0</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(addr);</span><br><span class="line">    I2CWaitAck();</span><br><span class="line">  I2CSendByte(date);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CStop();</span><br><span class="line"><span class="comment">//  EA=1;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//从 EEPROM 读取数据</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">r_eeprom</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> date;</span><br><span class="line"><span class="comment">//  EA=0;</span></span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0xA0</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  I2CSendByte(addr);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">    </span><br><span class="line">  I2CStart();</span><br><span class="line">  I2CSendByte(<span class="number">0xA1</span>);</span><br><span class="line">  I2CWaitAck();</span><br><span class="line">  date=I2CReceiveByte();</span><br><span class="line">  I2CSendAck(<span class="number">1</span>);</span><br><span class="line">  I2CStop();</span><br><span class="line"><span class="comment">//  EA=1;</span></span><br><span class="line">  <span class="keyword">return</span> date;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="七、超声波"><a href="#七、超声波" class="headerlink" title="七、超声波"></a>七、超声波</h2><p>使用超声波模块时，需正确连接J2跳线帽（1 - 3和2 - 4）。通过以下代码实现超声波的发射与接收，并计算距离。</p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_12.png"></p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_13.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span></span></span><br><span class="line"><span class="type">float</span> distance;<span class="comment">//距离</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//----------引脚定义----------</span></span><br><span class="line">sbit TX=P1^<span class="number">0</span>;</span><br><span class="line">sbit RX=P1^<span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//-------超声波发送延时-------</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay</span><span class="params">()</span>&#123;</span><br><span class="line">    _nop_();_nop_();_nop_();_nop_();_nop_();</span><br><span class="line">    _nop_();_nop_();_nop_();_nop_();_nop_();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//---------发送超声波脉冲---------</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">send_wave</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i=<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        TX=<span class="number">1</span>;</span><br><span class="line">        delay();</span><br><span class="line">        TX=<span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">while</span>(i--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//----------接收超声波并计算距离----------</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">re_wave</span><span class="params">()</span>&#123;</span><br><span class="line">    send_wave();</span><br><span class="line">    TH1=<span class="number">0</span>;</span><br><span class="line">    TL1=<span class="number">0</span>;</span><br><span class="line">    TR1=<span class="number">1</span>;        <span class="comment">//启动定时器1，开始计时</span></span><br><span class="line">    <span class="keyword">while</span>((RX==<span class="number">1</span>)&amp;&amp;(TF1==<span class="number">0</span>));</span><br><span class="line">    TR1=<span class="number">0</span>;        <span class="comment">//停止定时器1，结束计时</span></span><br><span class="line">    <span class="comment">// 检查定时器1是否溢出</span></span><br><span class="line">    <span class="keyword">if</span>(TF1)&#123;</span><br><span class="line">        TF1=<span class="number">0</span>;</span><br><span class="line">        distance=<span class="number">0.0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        distance=(<span class="type">float</span>)(TH1&lt;&lt;<span class="number">8</span>|TL1)*<span class="number">0.017</span>;</span><br><span class="line">        <span class="keyword">if</span>((<span class="type">int</span>)distance&gt;<span class="number">500</span>) distance=<span class="number">0.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>main()</code> 函数中需添加 <code>TMOD|=0x10;</code> 配置定时器。</p>
<h2 id="八、NE555"><a href="#八、NE555" class="headerlink" title="八、NE555"></a>八、NE555</h2><p>使用NE555模块时，要连接跳线帽NET_SIG和SIG_OUT。该模块利用定时器0的计数器模式对脉冲进行计数。</p>
<p><img src="/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/0002_14.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Timer0_Init</span><span class="params">(<span class="type">void</span>)</span>    <span class="comment">//100微秒@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">  TMOD &amp;= <span class="number">0xF0</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">  TMOD |= <span class="number">0x05</span>;</span><br><span class="line">  TL0 = <span class="number">0x00</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">  TH0 = <span class="number">0x00</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">  TF0 = <span class="number">0</span>;				<span class="comment">//清除TF0标志</span></span><br><span class="line">  TR0 = <span class="number">1</span>;				<span class="comment">//定时器0开始计时</span></span><br><span class="line">  ET0 = <span class="number">0</span>;				<span class="comment">//禁止使能定时器0中断</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//读计数器计数值</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">get_count</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> temp;</span><br><span class="line">  temp=TH0&lt;&lt;<span class="number">8</span>|TL0;</span><br><span class="line">  TH0=<span class="number">0X00</span>;</span><br><span class="line">  TL0=<span class="number">0X00</span>;</span><br><span class="line">  <span class="keyword">if</span>(TF0)&#123;<span class="comment">//如果检测到T0溢出，证明了频率超过了65535</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xffff</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时利用定时器1每秒读取一次计数器数值以获取频率。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ne555_count;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">Timer1_Init</span><span class="params">(<span class="type">void</span>)</span>    <span class="comment">//1毫秒@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">  AUXR |= <span class="number">0x40</span>;			<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">  TMOD &amp;= <span class="number">0x0F</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">  TL1 = <span class="number">0x20</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">  TH1 = <span class="number">0xD1</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">  TF1 = <span class="number">0</span>;				<span class="comment">//清除TF1标志</span></span><br><span class="line">  TR1 = <span class="number">1</span>;				<span class="comment">//定时器1开始计时</span></span><br><span class="line">  ET1 = <span class="number">1</span>;				<span class="comment">//使能定时器1中断</span></span><br><span class="line">  EA=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Timer1_Isr</span><span class="params">(<span class="type">void</span>)</span> interrupt 3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> count1=<span class="number">0</span>;</span><br><span class="line">  count1++;</span><br><span class="line">  <span class="keyword">if</span>(count1==<span class="number">1000</span>)&#123;</span><br><span class="line">    ne555_count=get_count();</span><br><span class="line">    count1=<span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="九、串口"><a href="#九、串口" class="headerlink" title="九、串口"></a>九、串口</h2><p>串口部分可借助烧录软件生成基础代码，再根据需求完善发送和接收功能。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">UartInit</span><span class="params">(<span class="type">void</span>)</span>    <span class="comment">//9600bps@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    SCON = <span class="number">0x50</span>;    <span class="comment">//8位数据,可变波特率</span></span><br><span class="line">    AUXR |= <span class="number">0x40</span>;    <span class="comment">//定时器时钟1T模式</span></span><br><span class="line">    AUXR &amp;= <span class="number">0xFE</span>;    <span class="comment">//串口1选择定时器1为波特率发生器</span></span><br><span class="line">    TMOD &amp;= <span class="number">0x0F</span>;    <span class="comment">//设置定时器模式</span></span><br><span class="line">    TL1 = <span class="number">0xC7</span>;      <span class="comment">//设置定时初始值</span></span><br><span class="line">    TH1 = <span class="number">0xFE</span>;      <span class="comment">//设置定时初始值</span></span><br><span class="line">    ET1 = <span class="number">0</span>;      <span class="comment">//禁止定时器中断</span></span><br><span class="line">    TR1 = <span class="number">1</span>;      <span class="comment">//定时器1开始计时</span></span><br><span class="line">    <span class="comment">//下面需要自行添加</span></span><br><span class="line"><span class="comment">//  ES =1;  //中断入口</span></span><br><span class="line">    EA =<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> rdat;</span><br><span class="line"></span><br><span class="line"><span class="comment">//串口发送一个字符</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_send_byte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> date)</span>&#123;</span><br><span class="line">        SBUF = date;<span class="comment">//发送数据</span></span><br><span class="line">        <span class="keyword">while</span>(TI==<span class="number">0</span>);<span class="comment">//等待数据发送完成</span></span><br><span class="line">        TI=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//串口发送一个字符串</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_send_str</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *str)</span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(*str != <span class="string">&#x27;\0&#x27;</span>)&#123;</span><br><span class="line">        uart_send_byte(*str++);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//串口中断服务函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">isr_uart</span><span class="params">()</span> interrupt 4</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//如果接收到数据</span></span><br><span class="line">    <span class="keyword">if</span>(RI)&#123;</span><br><span class="line">        RI=<span class="number">0</span>;</span><br><span class="line">        rdat=SBUF;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，还可通过重载 <code>putchar()</code> 函数使用 <code>printf()</code> 进行串口数据发送。这需要在 <code>main.c</code> 里对 <code>putchar()</code> 函数进行重载：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加头文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="title function_">putchar</span><span class="params">(<span class="type">char</span> ch)</span>&#123;</span><br><span class="line">    SBUF=ch;</span><br><span class="line">    <span class="keyword">while</span>(!TI);</span><br><span class="line">    TI=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> Vrb2;</span><br><span class="line">...</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">   ...</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">       ...</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;电压值为：%.2f \r\n&quot;</span>,Vrb2);</span><br><span class="line">        <span class="comment">//串口发送电压值，保留两位小数</span></span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这种方式，可以方便地将格式化的数据通过串口发送出去，使得数据的展示更加直观和易于理解，在调试和数据传输过程中具有重要作用。</p>
<h2 id="个人代码编写习惯或者说模板"><a href="#个人代码编写习惯或者说模板" class="headerlink" title="个人代码编写习惯或者说模板"></a>个人代码编写习惯或者说模板</h2><p>sys.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __SYS_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SYS_H__</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F2K61S2&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//sys.c</span></span><br><span class="line"><span class="comment">//seg_key.c</span></span><br><span class="line"><span class="comment">//iic.c</span></span><br><span class="line"><span class="comment">//ds1302.c</span></span><br><span class="line"><span class="comment">//onewire.c</span></span><br><span class="line"><span class="comment">//以上.c文件的变量和函数均在sys.h中声明一编</span></span><br><span class="line"></span><br><span class="line">...<span class="comment">//extern 声明外部变量</span></span><br><span class="line">...<span class="comment">//函数声明</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>main.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line">...<span class="comment">//相关变量或标志定义</span></span><br><span class="line"> </span><br><span class="line">...<span class="comment">//中断、串口等初始化函数</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    ...<span class="comment">//初始化</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">...<span class="comment">//中断服务函数和串口服务</span></span><br></pre></td></tr></table></figure>

<p>sys.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line">...<span class="comment">//整个项目需要用到的一些变量</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">init74hc138</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> n)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;<span class="comment">//74HC138译码器选通控制</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;<span class="comment">//系统初始化</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">led</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> n)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;<span class="comment">//选择LED指示灯点亮</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">buzz</span><span class="params">(bit flag)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;<span class="comment">//蜂鸣器</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">relay</span><span class="params">(bit flag)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;<span class="comment">//继电器</span></span><br><span class="line"> </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>seg_key.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line">code <span class="type">unsigned</span> <span class="type">char</span> Seg_Table[]=&#123;&#125;;<span class="comment">//数码表</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> Seg_Buff[<span class="number">8</span>]=&#123;&#125;;<span class="comment">//数码管缓存</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> keyval=<span class="number">0</span>,keyold=<span class="number">0</span>,keyup,keydown;<span class="comment">//按键相关</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">key_scan</span><span class="params">()</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">Key_Loop</span><span class="params">()</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">seg</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr,num)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">Seg_Loop</span><span class="params">()</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">ui0</span><span class="params">()</span>&#123;</span><br><span class="line">    Seg_Buff[<span class="number">7</span>]=N;</span><br><span class="line">        ...</span><br><span class="line">    Seg_Buff[<span class="number">0</span>]=M;</span><br><span class="line">&#125;</span><br><span class="line">      ........</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">uin</span><span class="params">()</span>&#123;</span><br><span class="line">    Seg_Buff[<span class="number">7</span>]=N;</span><br><span class="line">        ...</span><br><span class="line">    Seg_Buff[<span class="number">0</span>]=M;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">seg_ui</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(UI)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: ui0(); <span class="keyword">break</span>;</span><br><span class="line">                ...</span><br><span class="line">        <span class="keyword">case</span> n: uin(); <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">//界面选择</span></span><br></pre></td></tr></table></figure>

<p>还有其他外设的具体实现等等。</p>
<p>​	总之，通过对各个功能模块的深入理解和精心编写代码，并遵循良好的代码编写习惯，能够在蓝桥杯单片机竞赛中构建出稳定、高效且功能丰富的系统，为取得优异成绩打下坚实的基础。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://759li.github.io/2024/02/20/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%8D%95%E7%89%87%E6%9C%BA%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E6%80%BB%E7%BB%93/" data-id="cuid3IsvhdRyr4f0Okq7WgqmW" data-title="蓝桥杯单片机代码编写总结" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/03/10/%E7%9E%8E%E9%BC%93%E6%8D%A3/%E6%96%87%E4%BB%B6%E6%89%B9%E9%87%8F%E9%87%8D%E5%91%BD%E5%90%8D%E5%B7%A5%E5%85%B7/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          文件批量重命名工具
        
      </div>
    </a>
  
  
    <a href="/2023/11/02/%E8%AF%97%E9%9B%86/2023-%E5%A4%9C%E9%9B%A8%E7%9F%A5%E7%A7%8B/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">夜雨晓秋</div>
    </a>
  
</nav>

  
</article>



 
  <span style="margin: 0 8px;">|</span>
  <span class="busuanzi-count" style="color: #666;">
    <i class="fa fa-book" style="margin: 0 3px;"></i> 
    阅读量：<span id="busuanzi_value_page_pv"></span> 次
  </span>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%9A%E5%AE%A2%E5%85%A5%E9%97%A8/">博客入门</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%8D%95%E7%89%87%E6%9C%BA/">嵌入式单片机</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%B5%E8%84%91%E8%AE%BE%E5%A4%87/">电脑设备</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%9E%8E%E9%BC%93%E6%8D%A3/">瞎鼓捣</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%97%E9%9B%86/">诗集</a><span class="category-list-count">60</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%97%E9%9B%86/%E6%97%A0%E6%9C%9F/">无期</a><span class="category-list-count">23</span></li></ul></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/">2025</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/">2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">33</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2004/">2004</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/11/07/%E7%9E%8E%E9%BC%93%E6%8D%A3/%E8%A1%80%E7%B3%96%E8%AF%95%E7%BA%B8Y330%EF%BC%9A%E7%BB%93%E6%9E%84%E4%B8%8E%E5%8A%9F%E8%83%BD%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90/">血糖试纸Y330：结构与功能的深度剖析</a>
          </li>
        
          <li>
            <a href="/2025/11/04/%E7%94%B5%E8%84%91%E8%AE%BE%E5%A4%87/Ubuntu%E7%B3%BB%E7%BB%9F%E6%90%AD%E5%BB%BASamba%E6%9C%8D%E5%8A%A1%E5%85%A8%E6%B5%81%E7%A8%8B%EF%BC%88%E6%89%93%E9%80%A0%E7%A7%81%E6%9C%89%E7%BD%91%E7%9B%98%EF%BC%89/">Ubuntu系统搭建Samba服务全流程（打造私有网盘）</a>
          </li>
        
          <li>
            <a href="/2025/10/01/%E7%94%B5%E8%84%91%E8%AE%BE%E5%A4%87/%E4%B8%9C%E9%91%AB%E5%8F%B0%E5%BC%8F%E7%94%B5%E8%84%91%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E6%95%B4%E7%90%86/">东鑫台式（Intel 赛扬 G1840）电脑完整配置信息整理</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 左窗（默蝶）<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
    <br>
    <div class="busuanzi-count" style="font-size: 0.9em; color: #666;">
      <span id="busuanzi_container_site_uv">
        总访客数：<i class="fa fa-user" style="margin: 0 3px;"></i> 
        <span id="busuanzi_value_site_uv"></span> 人
      </span>
      <span style="margin: 0 8px;">|</span>
      <span id="busuanzi_container_site_pv">
        总浏览量：<i class="fa fa-eye" style="margin: 0 3px;"></i> 
        <span id="busuanzi_value_site_pv"></span> 次
      </span>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>